function define(exportedArgs){var exports=exportedArgs;function errorToString(){return this.name+": "+this.message}function DoesNotUnderstandError(state,event,args){if(Error.captureStackTrace)Error.captureStackTrace(this,this.constructor);this.state=state;this.message="State '"+state.name+"' does not understand the '"+event+"' event";this.event=event;this.args=args}DoesNotUnderstandError.prototype.__proto__=Error.prototype;DoesNotUnderstandError.prototype.toString=errorToString;DoesNotUnderstandError.prototype.name=DoesNotUnderstandError.prototype.constructor.name;exports.DoesNotUnderstandError=DoesNotUnderstandError;function TransitionError(message,sourceState,targetState,err){if(Error.captureStackTrace)Error.captureStackTrace(this,this.constructor);this.message="while moving from state '"+sourceState.name+"' to state '"+targetState.name+"': "+message;this.sourceState=sourceState;this.targetState=targetState;this.err=err}TransitionError.prototype.__proto__=Error.prototype;TransitionError.prototype.toString=errorToString;TransitionError.prototype.name=TransitionError.prototype.constructor.name;exports.TransitionError=TransitionError;function NestedTransitionError(sourceState,targetState){if(Error.captureStackTrace)Error.captureStackTrace(this,this.constructor);this.message="Transition was run to completion before another transition is requested; _enter/_exit must NOT request a transition";this.sourceState=sourceState;this.targetState=targetState}NestedTransitionError.prototype.__proto__=Error.prototype;NestedTransitionError.prototype.toString=errorToString;NestedTransitionError.prototype.name=NestedTransitionError.prototype.constructor.name;exports.NestedTransitionError=NestedTransitionError;function AssertionError(message){if(Error.captureStackTrace)Error.captureStackTrace(this,this.constructor);this.message=message}AssertionError.prototype.__proto__=Error.prototype;AssertionError.prototype.toString=errorToString;AssertionError.prototype.name=AssertionError.prototype.constructor.name;exports.AssertionError=AssertionError;function assert(contidition,message){if(!contidition)throw new AssertionError(message)}function StateInitializationError(message){if(Error.captureStackTrace)Error.captureStackTrace(this,this.constructor);this.message=message}StateInitializationError.prototype.__proto__=Error.prototype;StateInitializationError.prototype.toString=errorToString;StateInitializationError.prototype.name=StateInitializationError.prototype.constructor.name;exports.StateInitializationError=StateInitializationError;var debugMode=false;exports.dbgMode=function(isEnabled){if(isEnabled===undefined){return debugMode}assert(typeof isEnabled=="boolean");debugMode=isEnabled;return debugMode};exports.dbgInspectState=function(topState){function write(lev,state,lines){var text="";if(lev>0){var i=0;for(;i<lev;++i){text+="   "}text+="+- ";++i}if(lev==0)text+=" - ";text+=state.name;if(state.__proto__.initialState==state)text+="*";lines.push(text);for(i=0;i<state.subStates.length;++i){write(lev+1,state.subStates[i],lines)}}var l=[];write(0,topState,l);return l.join("\n")+"\n"};function State(stateName,parentState){this.name=stateName;this.initialState=null;this.subStates=[];this.error=function(e,err){throw err};this.doesNotUnderstandError=function(evt,e,args){throw new DoesNotUnderstandError(this.dispatch.state.name,e,args)};if(parentState!==undefined){this.trace=parentState.trace||function(){}}else{if(exports.dbgMode){this.trace=function(){console.log(arguments)}}else{this.trace=function(){}}}if(exports.dbgMode){this.enter=function(){this.hsm.state.trace.call(this,"enter "+this.hsm.state.name)}}else{this.enter=function(){}}if(exports.dbgMode){this.exit=function(){this.hsm.state.trace.call(this,"exit "+this.hsm.state.name)}}else{this.exit=function(){}}if(parentState!==undefined)this.__proto__=parentState}exports.State=State;State.prototype=new State("Root");exports.Root=State.prototype;var Root=State.prototype;function hasSubState(state,subStateName){var len=state.subStates.length;for(var i=0;i<len;++i){if(state.subStates===undefined){assert(state.subStates!==undefined)}if(state.subStates[i].name==subStateName)return true}return false}exports.state=function(name,parentState,isInitialState){if(typeof name!="string"){throw new TypeError("name is not a string")}if(parentState===undefined)return new State(name);if(!(parentState instanceof State)){throw new TypeError("parentState is not a state")}var parentSubStates=parentState.subStates;var parentInitialState=parentState.initialState;assert(parentSubStates instanceof Array);if(hasSubState(parentState,name))throw new StateInitializationError("State '"+name+"' is already stored in parentState");var state=new State(name,parentState);if(isInitialState==true){parentSubStates.push(state);parentState.initialState=state;return state}else if(isInitialState===undefined){parentSubStates.push(state);if(parentInitialState==null)parentState.initialState=state;return state}else if(typeof isInitialState!="boolean"){throw new TypeError("isInitialState must be a boolean")}else{parentSubStates.push(state);return state}};function TransitionTerminationError(){}TransitionTerminationError.prototype=new TransitionTerminationError;TransitionTerminationError.prototype.name=TransitionTerminationError.prototype.constructor.name;TransitionTerminationError.prototype.message="obj.qwe.tran should not be called out of an EventCallback";exports.TransitionTerminatedError=TransitionTerminationError;var tre=TransitionTerminationError.prototype;function EventBufferOverflowError(){}EventBufferOverflowError.prototype=new EventBufferOverflowError;EventBufferOverflowError.prototype.name=EventBufferOverflowError.prototype.constructor.name;EventBufferOverflowError.prototype.message="Maximum number of self sends (4) reached";exports.MessageDispatchError=EventBufferOverflowError;var mde=EventBufferOverflowError.prototype;function Behaviour(obj,state){this.isDispatching=false;this.eventBuffer=[null,null,null,null];this.eventIndex=0;this.obj=obj;this.state=state;this.locked=false;this.previousState=Root;this.stateChangedCallback=function(){};this.trace=function(){this.state.trace.apply(this.obj,arguments)}}Behaviour.prototype.send=function(evt){if(this.isDispatching){if(this.eventBuffer[this.eventIndex]!=null){throw new mde}this.eventBuffer[this.eventIndex++]=arguments;if(this.eventIndex==4){this.eventIndex=0}return}else{this.isDispatching=true}var f=this.state[evt];if(f===undefined){this.state.doesNotUnderstandError.call(this.obj,"doesNotUnderstandError",evt,arguments);return}try{f.apply(this.obj,arguments)}catch(err){if(err!=tre){this.state.error.call(this.obj,"error",err,evt,arguments)}else{this.stateChangedCallback.call(this.obj,this.previousState,this.state)}}finally{this.isDispatching=false}for(;;){var prev=this.eventIndex-1;if(prev==-1){prev=3}var message=this.eventBuffer[prev];if(message!=null){this.send(message);this.eventIndex=prev}else{break}}};Behaviour.prototype.tran=function(t){this.previousState=this.state;assert(t instanceof State);var s=this.state;if(t==s){this.exitState(t);this.enterState(t);throw tre}if(t==s.__proto__){this.exitState(t);this.state=t;this.drillDown();throw tre}if(t.__proto__==s.__proto__){this.exitState(t);this.state=t;this.enterState(t);this.drillDown();throw tre}var sourceAncestor=[];var state=s;for(;;){if(state==Root)break;sourceAncestor.push(state);state=state.__proto__;if(state==t){for(var i=0;i<sourceAncestor.length;++i){state=sourceAncestor[i];this.exitState(t);this.state=state.__proto__}this.drillDown();throw tre}}sourceAncestor.push(Root);var enterPath=[t];state=t.__proto__;for(;;){var idx=sourceAncestor.indexOf(state);if(idx==-1){enterPath.push(state);state=state.__proto__}else{break}}for(;;){this.exitState(t);this.state=this.state.__proto__;if(this.state==state)break}while(enterPath!=0){this.state=enterPath.pop();this.enterState(t)}this.drillDown();throw tre};Behaviour.prototype.enterState=function(state){if(this.locked)throw new TransitionError("Fatal Error: Cannot execute a transition while entering a state",this.state,state,new NestedTransitionError(this.state,state));this.locked=true;try{this.state.enter.call(this.obj,"enter")}catch(err){throw new TransitionError("Fatal Error: An error was thrown by the 'enter' callback: "+err.name+" "+err.message,this.state,state,err)}finally{this.locked=false}};Behaviour.prototype.exitState=function(state){if(this.locked)throw new TransitionError("Cannot execute a transition while exiting a state",this.state,state,new NestedTransitionError(this.state,state));this.locked=true;try{this.state.exit.call(this.obj,"exit")}catch(err){throw new TransitionError("An error was thrown by the '_exit' callback",this.state,state,err)}finally{this.locked=false}};Behaviour.prototype.drillDown=function(){for(;;){var initialState=this.state.initialState;if(initialState==null)break;this.state=initialState;this.enterState(initialState)}};exports.init=function(obj,state,stateChangedCallback){if(typeof obj!=="object")throw new TypeError("obj argument must be an object type");if(!(state instanceof State))throw new TypeError("state argument must be an instanceof State");if(!(state.__proto__.name=="Root"))throw new TypeError("state must be a top state instead state has as parent: "+state.__proto__.name);var hsm=new Behaviour(obj,state);obj.hsm=hsm;hsm.enterState(state);hsm.drillDown();obj.hsm.previousState=hsm.state;if(stateChangedCallback!==undefined){obj.hsm.stateChangedCallback=stateChangedCallback}};return exports}define(typeof exports==="undefined"?this.qwe={}:exports);